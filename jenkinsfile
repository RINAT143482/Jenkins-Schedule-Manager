pipeline {
    agent any

    parameters {
        string(name: 'Day', defaultValue: 'Monday', description: 'Day of the class')
        string(name: 'Time', defaultValue: '10:00', description: 'Time of the class')
        string(name: 'Subject', defaultValue: 'Math', description: 'Subject of the class')
    }

    stages {
        stage('Validate Parameters') {
            steps {
                script {
                    echo "Parameters validated: Day=${params.Day}, Time=${params.Time}, Subject=${params.Subject}"
                }
            }
        }

        stage('Checkout') {
            steps {
                script {
                    echo 'Checking out the repository...'
                    checkout scm
                }
            }
        }

        stage('Validate Files') {
            steps {
                script {
                    if (fileExists('schedule.ps1')) {
                        echo 'Schedule PowerShell script exists.'
                    } else {
                        error 'Schedule PowerShell script not found!'
                    }
                }
            }
        }

        stage('Execute PowerShell Script') {
            steps {
                script {
                    echo 'Running PowerShell schedule manager script...'
                    bat 'powershell -NoProfile -ExecutionPolicy Bypass -File "schedule.ps1"'
                }
            }
        }

        stage('Publish HTML Report') {
            steps {
                script {
                    echo 'Publishing HTML output...'
                    if (!fileExists("${env.WORKSPACE}\\output")) {
                        bat "mkdir ${env.WORKSPACE}\\output"
                    }
                    publishHTML([
                        allowMissing: false,
                        keepAll: true,
                        reportDir: 'output',
                        reportFiles: 'schedule.html',
                        reportName: 'Schedule Report'
                    ])
                }
            }
        }
    }

    post {
        success {
            echo 'Pipeline completed successfully!'
            script {
                def outputPath = "${env.WORKSPACE}\\output\\schedule.html"
                if (fileExists(outputPath)) {
                    echo "Access the schedule here: file://${outputPath}"
                } else {
                    echo "Output HTML file not found."
                }
            }
        }

        failure {
            echo 'Pipeline failed!'
        }
    }
}
